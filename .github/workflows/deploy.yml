name: Deploy to Production

on:
  push:
    branches: [main]

env:
  DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
  SERVER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-server
  UI_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-ui
  SITE_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-website

jobs:
  # â”€â”€â”€ Step 1: Build & Push Docker Images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # â”€â”€ Server Image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build & Push Server
        uses: docker/build-push-action@v6
        with:
          context: ./server
          push: true
          tags: |
            ${{ env.SERVER_IMAGE }}:latest
            ${{ env.SERVER_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.SERVER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.SERVER_IMAGE }}:buildcache,mode=max

      # â”€â”€ UI Image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build & Push UI
        uses: docker/build-push-action@v6
        with:
          context: ./ui
          push: true
          tags: |
            ${{ env.UI_IMAGE }}:latest
            ${{ env.UI_IMAGE }}:${{ github.sha }}
          build-args: |
            VITE_WS_URL=https://ws.voxeia.com
          cache-from: type=registry,ref=${{ env.UI_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.UI_IMAGE }}:buildcache,mode=max

      # â”€â”€ SaaS Website Image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build & Push Website
        uses: docker/build-push-action@v6
        with:
          context: ./saas-website
          push: true
          tags: |
            ${{ env.SITE_IMAGE }}:latest
            ${{ env.SITE_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.SITE_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.SITE_IMAGE }}:buildcache,mode=max

  # â”€â”€â”€ Step 2: Deploy to VPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy to VPS
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            APP_DIR=/root/voxeia

            # â”€â”€ Create app dir if not exists â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            # â”€â”€ Login to DockerHub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # â”€â”€ Pull latest images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-server:latest
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-ui:latest
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-website:latest

            # â”€â”€ Write docker-compose.prod.yml â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            cat > docker-compose.prod.yml << 'COMPOSEOF'
            version: "3.8"

            services:
              mongo:
                image: mongo:7
                container_name: voxeia-mongo
                restart: unless-stopped
                volumes:
                  - mongo_data:/data/db
                healthcheck:
                  test: echo 'db.runCommand("ping").ok' | mongosh --quiet
                  interval: 10s
                  timeout: 5s
                  retries: 5
                networks:
                  - voxeia-net

              server:
                image: DOCKERHUB_USER_PLACEHOLDER/voxeia-server:latest
                container_name: voxeia-server
                restart: unless-stopped
                ports:
                  - "127.0.0.1:9004:9004"
                  - "127.0.0.1:9005:9005"
                env_file:
                  - ./server/.env
                depends_on:
                  mongo:
                    condition: service_healthy
                networks:
                  - voxeia-net

              ui:
                image: DOCKERHUB_USER_PLACEHOLDER/voxeia-ui:latest
                container_name: voxeia-ui
                restart: unless-stopped
                ports:
                  - "127.0.0.1:9003:80"
                depends_on:
                  - server
                networks:
                  - voxeia-net

              saas-website:
                image: DOCKERHUB_USER_PLACEHOLDER/voxeia-website:latest
                container_name: voxeia-saas-website
                restart: unless-stopped
                ports:
                  - "127.0.0.1:9006:80"
                networks:
                  - voxeia-net

            volumes:
              mongo_data:
                driver: local

            networks:
              voxeia-net:
                driver: bridge
            COMPOSEOF

            # Replace placeholder with actual DockerHub username
            sed -i "s|DOCKERHUB_USER_PLACEHOLDER|${{ secrets.DOCKERHUB_USERNAME }}|g" docker-compose.prod.yml

            # â”€â”€ Write production .env for server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            mkdir -p server
            cat > server/.env << 'ENVEOF'
            TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}
            TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}
            TWILIO_PHONE_NUMBER=${{ secrets.TWILIO_PHONE_NUMBER }}
            PORT=9004
            WS_PORT=9005
            NODE_ENV=production
            CLIENT_URL=https://app.voxeia.com
            BASE_URL=https://api.voxeia.com
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            AI_SYSTEM_PROMPT=${{ secrets.AI_SYSTEM_PROMPT }}
            MONGODB_URI=mongodb://mongo:27017/voxeia
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRES_IN=7d
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            SMTP_FROM=${{ secrets.SMTP_FROM }}
            IMAGEKIT_PUBLIC_KEY=${{ secrets.IMAGEKIT_PUBLIC_KEY }}
            IMAGEKIT_PRIVATE_KEY=${{ secrets.IMAGEKIT_PRIVATE_KEY }}
            IMAGEKIT_URL_ENDPOINT=${{ secrets.IMAGEKIT_URL_ENDPOINT }}
            SARVAM_API_KEY=${{ secrets.SARVAM_API_KEY }}
            ENVEOF
            sed -i 's/^[[:space:]]*//' server/.env

            # â”€â”€ Write Nginx site config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            cat > /etc/nginx/sites-available/voxeia.com << 'NGINXEOF'
            # â”€â”€â”€ Rate Limiting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            limit_req_zone $binary_remote_addr zone=voxeia_general:10m rate=30r/s;
            limit_req_zone $binary_remote_addr zone=voxeia_api:10m rate=20r/s;
            limit_req_zone $binary_remote_addr zone=voxeia_site:10m rate=15r/s;

            # â”€â”€ voxeia.com â†’ SaaS Website (port 9006) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            server {
                listen 80;
                server_name voxeia.com www.voxeia.com;

                location / {
                    limit_req zone=voxeia_site burst=30 nodelay;
                    proxy_pass http://127.0.0.1:9006;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    add_header X-Frame-Options "SAMEORIGIN" always;
                    add_header X-Content-Type-Options "nosniff" always;
                    add_header X-XSS-Protection "1; mode=block" always;
                    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
                }
            }

            # â”€â”€ app.voxeia.com â†’ UI Dashboard (port 9003) â”€â”€â”€â”€â”€â”€â”€â”€â”€
            server {
                listen 80;
                server_name app.voxeia.com;

                location / {
                    limit_req zone=voxeia_general burst=40 nodelay;
                    proxy_pass http://127.0.0.1:9003;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    add_header Access-Control-Allow-Origin "https://voxeia.com" always;
                    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
                    add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization" always;
                    add_header Access-Control-Allow-Credentials "true" always;
                    add_header X-Frame-Options "SAMEORIGIN" always;
                    add_header X-Content-Type-Options "nosniff" always;
                }
            }

            # â”€â”€ api.voxeia.com â†’ Backend API (port 9004) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            server {
                listen 80;
                server_name api.voxeia.com;
                client_max_body_size 50M;

                location / {
                    limit_req zone=voxeia_api burst=50 nodelay;
                    proxy_pass http://127.0.0.1:9004;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_read_timeout 120s;
                    proxy_connect_timeout 10s;
                    add_header Access-Control-Allow-Origin "https://app.voxeia.com" always;
                    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
                    add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization" always;
                    add_header Access-Control-Allow-Credentials "true" always;
                    if ($request_method = OPTIONS) {
                        add_header Access-Control-Allow-Origin "https://app.voxeia.com";
                        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS";
                        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization";
                        add_header Access-Control-Allow-Credentials "true";
                        add_header Access-Control-Max-Age 86400;
                        add_header Content-Length 0;
                        return 204;
                    }
                    add_header X-Content-Type-Options "nosniff" always;
                }
            }

            # â”€â”€ ws.voxeia.com â†’ WebSocket (port 9005) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            server {
                listen 80;
                server_name ws.voxeia.com;

                location / {
                    proxy_pass http://127.0.0.1:9005;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_read_timeout 86400s;
                    proxy_send_timeout 86400s;
                    add_header Access-Control-Allow-Origin "https://app.voxeia.com" always;
                    add_header Access-Control-Allow-Credentials "true" always;
                }
            }
            NGINXEOF

            # â”€â”€ Enable site & reload Nginx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            ln -sf /etc/nginx/sites-available/voxeia.com /etc/nginx/sites-enabled/voxeia.com
            rm -f /etc/nginx/sites-enabled/default
            nginx -t && systemctl reload nginx

            # â”€â”€ Deploy containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            docker compose -f docker-compose.prod.yml down --remove-orphans
            docker compose -f docker-compose.prod.yml up -d

            # â”€â”€ Cleanup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            docker image prune -f

            echo "âœ… Deployment complete!"
            echo "ðŸŒ voxeia.com | app.voxeia.com | api.voxeia.com | ws.voxeia.com"
