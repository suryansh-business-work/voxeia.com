name: Deploy to Production

on:
  push:
    branches: [main]
    paths:
      - 'docker-compose.prod.yml'
      - 'nginx/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
  SERVER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-server
  UI_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-ui
  SITE_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-website
  ECOMM_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-ecomm

jobs:
  # ─── Step 1: Build & Push Docker Images ──────────────────────────
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ── Server Image ──────────────────────────────────────────
      - name: Build & Push Server
        uses: docker/build-push-action@v6
        with:
          context: ./server
          push: true
          tags: |
            ${{ env.SERVER_IMAGE }}:latest
            ${{ env.SERVER_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.SERVER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.SERVER_IMAGE }}:buildcache,mode=max

      # ── UI Image ──────────────────────────────────────────────
      - name: Build & Push UI
        uses: docker/build-push-action@v6
        with:
          context: ./ui
          push: true
          tags: |
            ${{ env.UI_IMAGE }}:latest
            ${{ env.UI_IMAGE }}:${{ github.sha }}
          build-args: |
            VITE_WS_URL=https://ws.voxeia.com
            VITE_API_URL=https://api.voxeia.com/api
          cache-from: type=registry,ref=${{ env.UI_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.UI_IMAGE }}:buildcache,mode=max

      # ── SaaS Website Image ───────────────────────────────────
      - name: Build & Push Website
        uses: docker/build-push-action@v6
        with:
          context: ./saas-website
          push: true
          tags: |
            ${{ env.SITE_IMAGE }}:latest
            ${{ env.SITE_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.SITE_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.SITE_IMAGE }}:buildcache,mode=max

      # ── E-commerce Demo Image ────────────────────────────────
      - name: Build & Push Ecomm
        uses: docker/build-push-action@v6
        with:
          context: ./ecomm-client-demo
          push: true
          tags: |
            ${{ env.ECOMM_IMAGE }}:latest
            ${{ env.ECOMM_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.ECOMM_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.ECOMM_IMAGE }}:buildcache,mode=max

  # ─── Step 2: Deploy to VPS ──────────────────────────────────────
  deploy:
    name: Deploy to VPS
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 20m
          script: |
            set -e

            APP_DIR=/root/voxeia

            # ── Create app dir ─────────────────────────────────────
            mkdir -p "$APP_DIR/server"
            cd "$APP_DIR"

            # ── Login to DockerHub ─────────────────────────────────
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # ── Pull latest images ─────────────────────────────────
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-server:latest
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-ui:latest
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-website:latest
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/voxeia-ecomm:latest

            # ── Write docker-compose.prod.yml ──────────────────────
            cat > docker-compose.prod.yml << 'COMPOSEOF'
            services:
              server:
                image: DOCKERHUB_USER_PLACEHOLDER/voxeia-server:latest
                container_name: voxeia-server
                restart: unless-stopped
                ports:
                  - "127.0.0.1:2002:2002"
                  - "127.0.0.1:2003:2003"
                env_file:
                  - ./server/.env
                environment:
                  - NODE_ENV=production
                  - CLIENT_URL=https://app.voxeia.com
                  - BASE_URL=https://api.voxeia.com
                healthcheck:
                  test: wget --no-verbose --tries=1 --spider http://127.0.0.1:2002/api/health || exit 1
                  interval: 30s
                  timeout: 5s
                  start_period: 15s
                  retries: 3
                networks:
                  - voxeia-net

              ui:
                image: DOCKERHUB_USER_PLACEHOLDER/voxeia-ui:latest
                container_name: voxeia-ui
                restart: unless-stopped
                ports:
                  - "127.0.0.1:2001:80"
                depends_on:
                  server:
                    condition: service_healthy
                healthcheck:
                  test: wget --no-verbose --tries=1 --spider http://127.0.0.1:80 || exit 1
                  interval: 30s
                  timeout: 5s
                  start_period: 5s
                  retries: 3
                networks:
                  - voxeia-net

              saas-website:
                image: DOCKERHUB_USER_PLACEHOLDER/voxeia-website:latest
                container_name: voxeia-saas-website
                restart: unless-stopped
                ports:
                  - "127.0.0.1:2000:80"
                healthcheck:
                  test: wget --no-verbose --tries=1 --spider http://127.0.0.1:80 || exit 1
                  interval: 30s
                  timeout: 5s
                  start_period: 5s
                  retries: 3
                networks:
                  - voxeia-net

              ecomm:
                image: DOCKERHUB_USER_PLACEHOLDER/voxeia-ecomm:latest
                container_name: voxeia-ecomm
                restart: unless-stopped
                ports:
                  - "127.0.0.1:2004:80"
                healthcheck:
                  test: wget --no-verbose --tries=1 --spider http://127.0.0.1:80 || exit 1
                  interval: 30s
                  timeout: 5s
                  start_period: 5s
                  retries: 3
                networks:
                  - voxeia-net

            networks:
              voxeia-net:
                driver: bridge
            COMPOSEOF

            sed -i "s|DOCKERHUB_USER_PLACEHOLDER|${{ secrets.DOCKERHUB_USERNAME }}|g" docker-compose.prod.yml

            # ── Write production .env for server ───────────────────
            cat > server/.env << 'ENVEOF'
            TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}
            TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}
            TWILIO_PHONE_NUMBER=${{ secrets.TWILIO_PHONE_NUMBER }}
            NODE_ENV=production
            CLIENT_URL=https://app.voxeia.com
            BASE_URL=https://api.voxeia.com
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            AI_SYSTEM_PROMPT=${{ secrets.AI_SYSTEM_PROMPT }}
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRES_IN=7d
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            SMTP_FROM=${{ secrets.SMTP_FROM }}
            IMAGEKIT_PUBLIC_KEY=${{ secrets.IMAGEKIT_PUBLIC_KEY }}
            IMAGEKIT_PRIVATE_KEY=${{ secrets.IMAGEKIT_PRIVATE_KEY }}
            IMAGEKIT_URL_ENDPOINT=${{ secrets.IMAGEKIT_URL_ENDPOINT }}
            SARVAM_API_KEY=${{ secrets.SARVAM_API_KEY }}
            ENVEOF
            sed -i 's/^[[:space:]]*//' server/.env

            # ── Write Nginx site config ────────────────────────────
            cat > /etc/nginx/sites-available/voxeia.com << 'NGINXEOF'
            # ─── Rate Limiting ─────────────────────────────────────
            limit_req_zone $binary_remote_addr zone=voxeia_general:10m rate=30r/s;
            limit_req_zone $binary_remote_addr zone=voxeia_api:10m rate=20r/s;
            limit_req_zone $binary_remote_addr zone=voxeia_site:10m rate=15r/s;

            server {
                listen 80;
                server_name voxeia.com www.voxeia.com;
                location / {
                    limit_req zone=voxeia_site burst=30 nodelay;
                    proxy_pass http://127.0.0.1:2000;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }

            server {
                listen 80;
                server_name app.voxeia.com;
                location / {
                    limit_req zone=voxeia_general burst=40 nodelay;
                    proxy_pass http://127.0.0.1:2001;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }

            server {
                listen 80;
                server_name api.voxeia.com;
                client_max_body_size 50M;
                location / {
                    limit_req zone=voxeia_api burst=50 nodelay;
                    proxy_pass http://127.0.0.1:2002;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_read_timeout 120s;
                    proxy_connect_timeout 10s;
                }
            }

            server {
                listen 80;
                server_name ws.voxeia.com;
                location / {
                    proxy_pass http://127.0.0.1:2003;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_read_timeout 86400s;
                    proxy_send_timeout 86400s;
                }
            }

            server {
                listen 80;
                server_name ecomm.voxeia.com;
                location / {
                    limit_req zone=voxeia_site burst=30 nodelay;
                    proxy_pass http://127.0.0.1:2004;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            NGINXEOF

            # ── Enable site & reload Nginx ─────────────────────────
            ln -sf /etc/nginx/sites-available/voxeia.com /etc/nginx/sites-enabled/voxeia.com
            rm -f /etc/nginx/sites-enabled/default
            nginx -t && systemctl reload nginx

            # ── Deploy containers ──────────────────────────────────
            docker compose -f docker-compose.prod.yml down --remove-orphans || true
            docker compose -f docker-compose.prod.yml up -d

            # ── Wait for healthy ───────────────────────────────────
            sleep 10
            docker compose -f docker-compose.prod.yml ps

            # ── SSL via Certbot (idempotent) ───────────────────────
            if ! command -v certbot &> /dev/null; then
              apt-get update -qq && apt-get install -y -qq certbot python3-certbot-nginx
            fi

            certbot --nginx \
              -d voxeia.com -d www.voxeia.com \
              -d app.voxeia.com \
              -d api.voxeia.com \
              -d ws.voxeia.com \
              -d ecomm.voxeia.com \
              --non-interactive --agree-tos \
              -m ${{ secrets.SSL_EMAIL }} \
              --redirect \
              --keep-until-expiring

            nginx -t && systemctl reload nginx

            # ── Cleanup ────────────────────────────────────────────
            docker image prune -f

            echo "✅ Full deployment complete with SSL!"
